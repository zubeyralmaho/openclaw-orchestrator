<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Orchestrator â€” Mindra</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --surface: #111114;
      --surface2: #18181b;
      --surface3: #1f1f23;
      --border: #27272a;
      --border-hover: #3f3f46;
      --text: #fafafa;
      --text-secondary: #a1a1aa;
      --text-dim: #71717a;

      --purple: #8B5CF6;
      --purple-light: #a78bfa;
      --purple-dark: #7c3aed;
      --purple-glow: rgba(139, 92, 246, 0.15);
      --purple-glow-strong: rgba(139, 92, 246, 0.3);

      --running: #8B5CF6;
      --pending: #3f3f46;
      --done: #22c55e;
      --done-dim: #166534;
      --failed: #ef4444;
      --failed-dim: #7f1d1d;

      --radius: 10px;
      --radius-sm: 6px;
      --radius-lg: 14px;
      --radius-xl: 18px;

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.15);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.2);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.25);
      --shadow-purple: 0 4px 20px rgba(139, 92, 246, 0.15), 0 0 0 1px rgba(139, 92, 246, 0.1);
      --shadow-purple-lg: 0 8px 32px rgba(139, 92, 246, 0.2), 0 0 0 1px rgba(139, 92, 246, 0.15);

      --gradient-purple: linear-gradient(135deg, #8B5CF6, #7c3aed);
      --gradient-hero-border: linear-gradient(135deg, rgba(139,92,246,0.4), rgba(139,92,246,0.1), rgba(139,92,246,0.3));
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Outfit', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      height: 56px;
      border-bottom: 1px solid var(--border);
      background: rgba(17, 17, 20, 0.8);
      backdrop-filter: blur(12px) saturate(1.5);
      -webkit-backdrop-filter: blur(12px) saturate(1.5);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      background: linear-gradient(135deg, var(--purple), var(--purple-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
      box-shadow: 0 0 12px var(--purple-glow-strong);
    }

    .logo-text {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .logo-text span {
      color: var(--text-dim);
      font-weight: 400;
    }

    #connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 400;
      font-family: 'JetBrains Mono', monospace;
      padding: 4px 12px;
      background: var(--surface2);
      border-radius: 100px;
      border: 1px solid var(--border);
    }

    #connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--pending);
      transition: all 0.3s;
    }

    #connection-dot.connected { background: var(--done); box-shadow: 0 0 6px rgba(34, 197, 94, 0.5); }
    #connection-dot.disconnected { background: var(--failed); box-shadow: 0 0 6px rgba(239, 68, 68, 0.4); }

    /* ---- Main layout ---- */
    main {
      max-width: 880px;
      margin: 0 auto;
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      transition: border-color 0.25s, box-shadow 0.25s;
      box-shadow: var(--shadow-sm);
    }

    section:hover {
      border-color: var(--border-hover);
    }

    section h2 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-dim);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    section h2::before {
      content: '';
      width: 3px;
      height: 14px;
      background: var(--gradient-purple);
      border-radius: 2px;
      flex-shrink: 0;
    }

    .hidden { display: none !important; }

    /* ---- Animations ---- */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ---- Goal panel hero ---- */
    #goal-panel {
      position: relative;
      overflow: hidden;
      border: 1px solid transparent;
      border-radius: var(--radius-xl);
      padding: 32px 32px 24px;
      box-shadow: var(--shadow-md);
    }

    #goal-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius-xl);
      padding: 1px;
      background: var(--gradient-hero-border);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    #goal-panel:hover {
      border-color: transparent;
    }

    .goal-glow {
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 120px;
      background: radial-gradient(ellipse, rgba(139, 92, 246, 0.12) 0%, transparent 70%);
      pointer-events: none;
    }

    .goal-header h2 {
      font-size: 16px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: -0.3px;
      color: var(--text);
      margin-bottom: 6px;
    }

    .goal-header h2::before { display: none; }

    .goal-header h2 svg { color: var(--purple-light); }

    .goal-subtitle {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 400;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    #goal-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      font-weight: 400;
      padding: 16px 20px;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.25s, box-shadow 0.25s, background 0.25s;
      line-height: 1.6;
    }

    #goal-input::placeholder { color: var(--text-dim); font-style: italic; }

    #goal-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 3px var(--purple-glow), var(--shadow-purple);
      background: rgba(9, 9, 11, 0.8);
    }

    .form-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-top: 16px;
    }

    .form-hint {
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .form-hint kbd {
      display: inline-block;
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1px 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    #submit-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--gradient-purple);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 10px 28px;
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-purple);
      position: relative;
      overflow: hidden;
    }

    #submit-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
      opacity: 0;
      transition: opacity 0.2s;
    }

    #submit-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-purple-lg); }
    #submit-btn:hover::after { opacity: 1; }
    #submit-btn:hover .btn-icon { transform: translateX(2px); }
    #submit-btn:active { transform: translateY(0) scale(0.98); }
    #submit-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
    #submit-btn:disabled::after { display: none; }

    .btn-icon { flex-shrink: 0; transition: transform 0.2s; }

    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* ---- State banner ---- */
    #state-banner {
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      padding: 12px 20px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      animation: fadeInUp 0.3s ease;
    }

    #state-banner.thinking,
    #state-banner.executing {
      background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(139,92,246,0.04));
      border: 1px solid rgba(139, 92, 246, 0.2);
      color: var(--purple-light);
    }

    #state-banner.done {
      background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(34,197,94,0.03));
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #86efac;
    }

    #state-banner.error {
      background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    /* ---- Step timeline ---- */
    #steps-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      color: var(--purple-light);
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(139,92,246,0.06), rgba(139,92,246,0.02));
      border: 1px dashed rgba(139, 92, 246, 0.25);
      border-radius: var(--radius);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.05);
      animation: fadeInUp 0.3s ease;
    }

    .thinking-dots {
      display: flex;
      gap: 5px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--purple-light);
      animation: thinking-bounce 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinking-bounce {
      0%, 80%, 100% { opacity: 0.25; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1.2); }
    }

    .step-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: border-color 0.3s, box-shadow 0.3s;
      box-shadow: var(--shadow-sm);
      animation: fadeInUp 0.35s ease;
    }

    .step-card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
    }

    .step-card.step-complete {
      border-color: rgba(34, 197, 94, 0.2);
    }

    .step-card.step-complete:hover {
      border-color: rgba(34, 197, 94, 0.35);
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 500;
    }

    .step-number {
      color: var(--purple-light);
      font-weight: 700;
      font-size: 13px;
      letter-spacing: -0.2px;
    }

    .step-task-count {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-dim);
      margin-left: 8px;
    }

    .step-status-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 3px 12px;
      border-radius: 100px;
      transition: all 0.3s;
    }

    .step-status-badge.running {
      background: var(--purple-glow);
      color: var(--purple-light);
      box-shadow: 0 0 8px rgba(139, 92, 246, 0.15);
    }

    .step-status-badge.complete {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
    }

    .step-tasks {
      padding: 4px 0;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 20px;
      font-size: 12px;
      transition: background 0.15s;
      border-bottom: 1px solid rgba(39, 39, 42, 0.5);
      position: relative;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .task-status-dot {
      width: 10px;
      height: 10px;
      min-width: 10px;
      border-radius: 50%;
      margin-top: 4px;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .task-status-dot.pending {
      background: var(--pending);
      box-shadow: inset 0 0 0 1.5px rgba(255,255,255,0.06);
    }

    .task-status-dot.running {
      background: var(--purple);
      box-shadow: 0 0 8px var(--purple-glow-strong), 0 0 2px var(--purple);
      animation: pulse-purple 2s ease-in-out infinite;
    }

    .task-status-dot.done {
      background: var(--done);
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.3);
    }

    .task-status-dot.failed {
      background: var(--failed);
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
    }

    @keyframes pulse-purple {
      0%, 100% { box-shadow: 0 0 0 0 var(--purple-glow-strong), 0 0 2px var(--purple); }
      50% { box-shadow: 0 0 0 6px rgba(139, 92, 246, 0), 0 0 2px var(--purple); }
    }

    .task-info {
      flex: 1;
      min-width: 0;
    }

    .task-id {
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11.5px;
      color: var(--text);
      margin-right: 8px;
    }

    .task-agent-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 10px 2px 8px;
      border-radius: 100px;
      margin-left: 4px;
      vertical-align: middle;
      transition: all 0.2s;
      background: rgba(139, 92, 246, 0.12);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.15);
    }

    .task-agent-badge::before {
      content: '';
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      flex-shrink: 0;
    }

    .task-agent-badge[data-agent-type="http"] {
      background: rgba(6, 182, 212, 0.12);
      color: #67e8f9;
      border-color: rgba(6, 182, 212, 0.15);
    }

    .task-agent-badge[data-agent-type="function"] {
      background: rgba(245, 158, 11, 0.12);
      color: #fcd34d;
      border-color: rgba(245, 158, 11, 0.15);
    }

    .task-desc {
      display: block;
      color: var(--text-secondary);
      margin-top: 3px;
      line-height: 1.5;
      font-size: 12.5px;
    }

    .task-output-toggle {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--purple-light);
      cursor: pointer;
      user-select: none;
      border: none;
      background: none;
      font-family: 'Outfit', sans-serif;
      padding: 3px 0;
      font-weight: 500;
      transition: color 0.15s;
    }

    .task-output-toggle:hover {
      color: var(--text);
    }

    .task-output {
      margin-top: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      background: var(--bg);
      border-radius: var(--radius);
      padding: 36px 20px 20px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      line-height: 1.65;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
      position: relative;
    }

    .task-output::before {
      content: 'OUTPUT';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 4px 20px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--text-dim);
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      font-family: 'Outfit', sans-serif;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .task-result-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 3px 10px;
      border-radius: 100px;
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .task-result-badge.ok {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.15);
    }

    .task-result-badge.error {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.15);
    }

    .task-result-badge.timeout {
      background: rgba(234, 179, 8, 0.1);
      color: #fde68a;
      border: 1px solid rgba(234, 179, 8, 0.15);
    }

    /* ---- Legend ---- */
    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      padding: 8px 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(39,39,42,0.5);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 400;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ---- Final answer ---- */
    #final-answer-panel {
      border-color: rgba(34, 197, 94, 0.2);
      box-shadow: var(--shadow-md), 0 0 20px rgba(34, 197, 94, 0.05);
      animation: fadeInUp 0.4s ease;
    }

    #final-answer-panel h2::before {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    #final-answer-output {
      font-size: 14px;
      background: var(--bg);
      border-radius: var(--radius);
      padding: 24px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.75;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
    }

    /* ---- Run history ---- */
    #history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12.5px;
      padding: 10px 16px;
      background: var(--surface2);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      box-shadow: var(--shadow-sm);
    }

    .history-item:hover {
      background: var(--surface3);
      border-color: var(--border);
      transform: translateX(2px);
      box-shadow: var(--shadow-md);
    }

    .history-item.active {
      border-color: var(--purple);
      background: var(--purple-glow);
      box-shadow: var(--shadow-purple);
    }

    .history-goal {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400;
      color: var(--text);
    }

    .history-time {
      font-size: 10px;
      color: var(--text-dim);
      white-space: nowrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .history-state {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 10px;
      border-radius: 100px;
      min-width: 64px;
      text-align: center;
      border: 1px solid transparent;
    }

    .history-state.done {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border-color: rgba(34, 197, 94, 0.12);
    }

    .history-state.error {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border-color: rgba(239, 68, 68, 0.12);
    }

    .history-state.executing,
    .history-state.thinking {
      background: var(--purple-glow);
      color: var(--purple-light);
      border-color: rgba(139, 92, 246, 0.15);
    }

    .history-delete-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .history-item:hover .history-delete-btn {
      opacity: 1;
    }

    .history-delete-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--failed);
    }

    .history-delete-btn svg {
      width: 14px;
      height: 14px;
    }

    /* ---- Scrollbar ---- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">M</div>
      <div class="logo-text">OpenClaw <span>Orchestrator</span></div>
    </div>
    <div id="connection-status">
      <div id="connection-dot"></div>
      <span id="connection-label">connecting...</span>
    </div>
  </header>

  <main>
    <section id="goal-panel">
      <div class="goal-glow"></div>
      <div class="goal-header">
        <h2>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="vertical-align:-2px;margin-right:4px;">
            <path d="M8 1L10.5 5.5L15 8L10.5 10.5L8 15L5.5 10.5L1 8L5.5 5.5L8 1Z" fill="currentColor" opacity="0.7"/>
          </svg>
          What would you like to accomplish?
        </h2>
        <p class="goal-subtitle">Describe your goal and the orchestrator will break it into steps, assign agents, and execute.</p>
      </div>
      <form id="goal-form">
        <textarea id="goal-input" placeholder="e.g. Research the top 3 competitors and summarize their pricing..." rows="3"></textarea>
        <div class="form-row">
          <div class="form-hint">
            <kbd>Ctrl</kbd> + <kbd>Enter</kbd> to run
          </div>
          <button type="submit" id="submit-btn">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" class="btn-icon">
              <path d="M2 8L14 8M14 8L9 3M14 8L9 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="btn-label">Run</span>
            <span class="btn-loading hidden">
              <span class="spinner"></span>
              Running...
            </span>
          </button>
        </div>
      </form>
    </section>

    <section id="state-banner" class="hidden"></section>

    <section id="steps-panel" class="hidden">
      <h2>Step Timeline</h2>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--pending)"></div>Pending</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--running)"></div>Running</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--done)"></div>Done</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--failed)"></div>Failed</div>
      </div>
      <div id="steps-container"></div>
    </section>

    <section id="final-answer-panel" class="hidden">
      <h2>Final Answer</h2>
      <div id="final-answer-output"></div>
    </section>

    <section id="history-panel" class="hidden">
      <h2>Run History</h2>
      <div id="history-list"></div>
    </section>
  </main>

  <script>
  (function() {
    "use strict";

    var currentRunId = null;
    var eventSource = null;
    var stepsData = {};

    function connectSSE() {
      eventSource = new EventSource("/api/events");
      eventSource.onmessage = function(e) {
        try { handleEvent(JSON.parse(e.data)); } catch (err) { console.error("SSE parse error:", err); }
      };
      eventSource.onopen = function() { updateConnection(true); };
      eventSource.onerror = function() { updateConnection(false); };
    }

    function updateConnection(connected) {
      var dot = document.getElementById("connection-dot");
      var label = document.getElementById("connection-label");
      dot.className = connected ? "connected" : "disconnected";
      label.textContent = connected ? "connected" : "reconnecting...";
    }

    function handleEvent(event) {
      // Handle run:deleted for any run (not just current)
      if (event.type === "run:deleted") {
        if (event.runId === currentRunId) {
          currentRunId = null;
          resetPanels();
        }
        updateHistory();
        return;
      }

      if (event.runId !== currentRunId) return;
      switch (event.type) {
        case "run:started":
          showBanner("thinking", "Thinking...");
          showThinkingIndicator();
          show("steps-panel");
          break;
        case "step:thinking":
          showBanner("thinking", "Thinking \u2014 deciding step " + event.stepNumber);
          showThinkingIndicator();
          break;
        case "step:started":
          removeThinkingIndicator();
          showBanner("executing", "Executing step " + event.stepNumber);
          addStepCard(event.stepNumber, event.taskIds, event.tasks);
          show("steps-panel");
          break;
        case "task:started":
          updateTaskStatus(event.stepNumber, event.taskId, "running");
          break;
        case "task:ended":
          updateTaskStatus(event.stepNumber, event.taskId, event.status, event.result);
          break;
        case "step:ended":
          markStepComplete(event.stepNumber);
          break;
        case "run:complete":
          removeThinkingIndicator();
          var durSec = (event.durationMs / 1000).toFixed(1);
          showBanner("done", "Completed in " + durSec + "s");
          if (event.answer) showFinalAnswer(event.answer);
          setSubmitEnabled(true);
          updateHistory();
          break;
        case "run:error":
          removeThinkingIndicator();
          showBanner("error", "Error: " + event.error);
          setSubmitEnabled(true);
          updateHistory();
          break;
      }
    }

    function setSubmitEnabled(enabled) {
      var btn = document.getElementById("submit-btn");
      btn.disabled = !enabled;
      var label = btn.querySelector(".btn-label");
      var loading = btn.querySelector(".btn-loading");
      if (label) label.classList.toggle("hidden", !enabled);
      if (loading) loading.classList.toggle("hidden", enabled);
    }

    function showThinkingIndicator() {
      removeThinkingIndicator();
      var container = document.getElementById("steps-container");
      var indicator = document.createElement("div");
      indicator.id = "thinking-indicator";
      indicator.className = "thinking-indicator";
      indicator.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div><span>Thinking...</span>';
      container.appendChild(indicator);
      scrollIntoViewIfNeeded(indicator);
    }

    function removeThinkingIndicator() {
      var el = document.getElementById("thinking-indicator");
      if (el) el.remove();
    }

    function addStepCard(stepNumber, taskIds, taskDetails) {
      var tasks = {};
      for (var i = 0; i < taskIds.length; i++) {
        var detail = taskDetails && taskDetails[i];
        tasks[taskIds[i]] = { id: taskIds[i], task: detail ? detail.task : "", agent: detail ? detail.agent : undefined, status: "pending", result: null };
      }
      stepsData[stepNumber] = { tasks: tasks };

      var container = document.getElementById("steps-container");
      var card = document.createElement("div");
      card.className = "step-card";
      card.id = "step-card-" + stepNumber;

      var header = document.createElement("div");
      header.className = "step-header";
      header.innerHTML = '<span><span class="step-number">Step ' + stepNumber + '</span><span class="step-task-count">' + taskIds.length + ' task' + (taskIds.length !== 1 ? 's' : '') + '</span></span><span class="step-status-badge running">running</span>';

      var tasksList = document.createElement("div");
      tasksList.className = "step-tasks";
      tasksList.id = "step-tasks-" + stepNumber;

      for (var i = 0; i < taskIds.length; i++) {
        var detail = taskDetails && taskDetails[i];
        tasksList.appendChild(createTaskItem(taskIds[i], detail ? detail.task : "", "pending", detail ? detail.agent : undefined));
      }

      card.appendChild(header);
      card.appendChild(tasksList);
      container.appendChild(card);
      scrollIntoViewIfNeeded(card);
    }

    function createTaskItem(taskId, taskDesc, status, agentName) {
      var item = document.createElement("div");
      item.className = "task-item";
      item.id = "task-item-" + sanitizeId(taskId);

      var dot = document.createElement("div");
      dot.className = "task-status-dot " + status;
      dot.id = "task-dot-" + sanitizeId(taskId);

      var info = document.createElement("div");
      info.className = "task-info";

      var line = document.createElement("div");
      var idSpan = document.createElement("span");
      idSpan.className = "task-id";
      idSpan.textContent = taskId;
      line.appendChild(idSpan);

      if (agentName) {
        var agentSpan = document.createElement("span");
        agentSpan.className = "task-agent-badge";
        agentSpan.textContent = agentName;
        var lower = agentName.toLowerCase();
        if (lower.indexOf('http') !== -1 || lower.indexOf('api') !== -1) {
          agentSpan.setAttribute('data-agent-type', 'http');
        } else if (lower.indexOf('func') !== -1 || lower.indexOf('local') !== -1) {
          agentSpan.setAttribute('data-agent-type', 'function');
        }
        line.appendChild(agentSpan);
      }

      info.appendChild(line);

      if (taskDesc) {
        var descSpan = document.createElement("span");
        descSpan.className = "task-desc";
        descSpan.textContent = taskDesc;
        info.appendChild(descSpan);
      }

      var outputContainer = document.createElement("div");
      outputContainer.id = "task-output-container-" + sanitizeId(taskId);
      info.appendChild(outputContainer);

      item.appendChild(dot);
      item.appendChild(info);
      return item;
    }

    function updateTaskStatus(stepNumber, taskId, status, result) {
      if (stepsData[stepNumber] && stepsData[stepNumber].tasks[taskId]) {
        stepsData[stepNumber].tasks[taskId].status = status;
        if (result) stepsData[stepNumber].tasks[taskId].result = result;
      }
      var dot = document.getElementById("task-dot-" + sanitizeId(taskId));
      if (dot) dot.className = "task-status-dot " + status;

      if (result && (status === "done" || status === "failed")) {
        var outputContainer = document.getElementById("task-output-container-" + sanitizeId(taskId));
        if (outputContainer && !outputContainer.hasChildNodes()) renderTaskResult(outputContainer, taskId, result);
      }
    }

    function renderTaskResult(container, taskId, result) {
      var badge = document.createElement("span");
      badge.className = "task-result-badge " + result.status;
      badge.textContent = result.status;
      container.appendChild(badge);

      if (result.output) {
        var toggleId = "toggle-" + sanitizeId(taskId);
        var outputId = "output-" + sanitizeId(taskId);

        var toggle = document.createElement("button");
        toggle.className = "task-output-toggle";
        toggle.id = toggleId;
        toggle.textContent = "\u25B6 Show output";
        toggle.addEventListener("click", function() {
          var outputEl = document.getElementById(outputId);
          if (!outputEl) return;
          var visible = outputEl.style.display !== "none";
          outputEl.style.display = visible ? "none" : "block";
          toggle.textContent = visible ? "\u25B6 Show output" : "\u25BC Hide output";
        });

        var outputPre = document.createElement("pre");
        outputPre.className = "task-output";
        outputPre.id = outputId;
        outputPre.style.display = "none";
        outputPre.textContent = result.output;

        container.appendChild(document.createElement("br"));
        container.appendChild(toggle);
        container.appendChild(outputPre);
      }
    }

    function markStepComplete(stepNumber) {
      var card = document.getElementById("step-card-" + stepNumber);
      if (!card) return;
      card.classList.add("step-complete");
      var badge = card.querySelector(".step-status-badge");
      if (badge) { badge.className = "step-status-badge complete"; badge.textContent = "complete"; }
    }

    function showFinalAnswer(text) {
      document.getElementById("final-answer-output").textContent = text;
      show("final-answer-panel");
      scrollIntoViewIfNeeded(document.getElementById("final-answer-panel"));
    }

    document.getElementById("goal-form").addEventListener("submit", function(e) {
      e.preventDefault();
      var goal = document.getElementById("goal-input").value.trim();
      if (!goal) return;
      resetPanels();
      var body = { goal: goal };
      setSubmitEnabled(false);

      fetch("/api/runs", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
        .then(function(r) { return r.json(); })
        .then(function(data) { currentRunId = data.runId; })
        .catch(function(err) { showBanner("error", "Failed to submit: " + err.message); setSubmitEnabled(true); });
    });

    document.getElementById("goal-input").addEventListener("keydown", function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        document.getElementById("goal-form").dispatchEvent(new Event("submit", { cancelable: true }));
      }
    });

    function updateHistory() {
      fetch("/api/runs").then(function(r) { return r.json(); }).then(function(runs) {
        if (!runs.length) return;
        show("history-panel");
        var list = document.getElementById("history-list");
        list.innerHTML = "";
        for (var i = 0; i < runs.length; i++) {
          var run = runs[i];
          var item = document.createElement("div");
          item.className = "history-item" + (run.runId === currentRunId ? " active" : "");

          var stateSpan = document.createElement("span");
          stateSpan.className = "history-state " + esc(run.state);
          stateSpan.textContent = run.state;

          var goalSpan = document.createElement("span");
          goalSpan.className = "history-goal";
          goalSpan.textContent = run.goal;

          var timeSpan = document.createElement("span");
          timeSpan.className = "history-time";
          if (run.startedAt) timeSpan.textContent = formatTime(run.startedAt);

          item.appendChild(stateSpan);
          item.appendChild(goalSpan);
          item.appendChild(timeSpan);

          var deleteBtn = document.createElement("button");
          deleteBtn.className = "history-delete-btn";
          deleteBtn.title = "Delete run";
          deleteBtn.innerHTML = '<svg viewBox="0 0 16 16" fill="none"><path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          deleteBtn.addEventListener("click", (function(rid, evt) {
            return function(e) {
              e.stopPropagation();
              deleteRun(rid);
            };
          })(run.runId));
          item.appendChild(deleteBtn);

          item.addEventListener("click", (function(rid) { return function() { loadRun(rid); }; })(run.runId));
          list.appendChild(item);
        }
      }).catch(function() {});
    }

    function loadRun(runId) {
      fetch("/api/runs/" + runId).then(function(r) { return r.json(); }).then(function(run) {
        resetPanels();
        currentRunId = run.runId;

        if (run.steps && run.steps.length) {
          show("steps-panel");
          for (var s = 0; s < run.steps.length; s++) {
            var step = run.steps[s];
            var tasksMap = {};
            for (var t = 0; t < step.tasks.length; t++) {
              var task = step.tasks[t];
              tasksMap[task.id] = { id: task.id, task: task.task, status: task.status, result: task.result || null };
            }
            stepsData[step.stepNumber] = { tasks: tasksMap };
            buildStepCardFromData(step);
          }
        }

        if (run.state === "thinking") { showThinkingIndicator(); show("steps-panel"); }
        if (run.finalAnswer) showFinalAnswer(run.finalAnswer);

        var bannerMsg = run.state;
        if (run.state === "done") {
          bannerMsg = (run.finishedAt && run.startedAt) ? "Completed in " + ((run.finishedAt - run.startedAt) / 1000).toFixed(1) + "s" : "Completed";
        } else if (run.state === "error") {
          bannerMsg = "Error: " + (run.error || "unknown");
        } else if (run.state === "thinking") {
          bannerMsg = "Thinking...";
        } else if (run.state === "executing") {
          bannerMsg = "Executing...";
        }
        showBanner(run.state, bannerMsg);
        var isActive = (run.state === "thinking" || run.state === "executing");
        setSubmitEnabled(!isActive);
        updateHistory();
      }).catch(function() {});
    }

    function buildStepCardFromData(step) {
      var container = document.getElementById("steps-container");
      var card = document.createElement("div");
      card.className = "step-card";
      card.id = "step-card-" + step.stepNumber;

      var allDone = true;
      for (var i = 0; i < step.tasks.length; i++) {
        if (step.tasks[i].status !== "done" && step.tasks[i].status !== "failed") { allDone = false; break; }
      }
      if (allDone) card.classList.add("step-complete");

      var header = document.createElement("div");
      header.className = "step-header";
      header.innerHTML = '<span><span class="step-number">Step ' + step.stepNumber + '</span><span class="step-task-count">' + step.tasks.length + ' task' + (step.tasks.length !== 1 ? 's' : '') + '</span></span><span class="step-status-badge ' + (allDone ? 'complete' : 'running') + '">' + (allDone ? 'complete' : 'running') + '</span>';

      var tasksList = document.createElement("div");
      tasksList.className = "step-tasks";
      tasksList.id = "step-tasks-" + step.stepNumber;

      for (var i = 0; i < step.tasks.length; i++) {
        var task = step.tasks[i];
        var taskItem = createTaskItem(task.id, task.task, task.status, task.agent);
        tasksList.appendChild(taskItem);
        if (task.result) {
          var outputContainer = document.getElementById("task-output-container-" + sanitizeId(task.id));
          if (outputContainer) renderTaskResult(outputContainer, task.id, task.result);
        }
      }

      card.appendChild(header);
      card.appendChild(tasksList);
      container.appendChild(card);
    }

    function show(id) { document.getElementById(id).classList.remove("hidden"); }
    function hide(id) { document.getElementById(id).classList.add("hidden"); }

    function showBanner(state, msg) {
      var banner = document.getElementById("state-banner");
      banner.className = state;
      banner.textContent = msg;
      show("state-banner");
    }

    function resetPanels() {
      stepsData = {};
      document.getElementById("steps-container").innerHTML = "";
      document.getElementById("final-answer-output").textContent = "";
      hide("state-banner");
      hide("steps-panel");
      hide("final-answer-panel");
    }

    function esc(str) { var div = document.createElement("div"); div.textContent = str || ""; return div.innerHTML; }
    function sanitizeId(id) { return id.replace(/[^a-zA-Z0-9_-]/g, "_"); }
    function scrollIntoViewIfNeeded(el) { if (el) el.scrollIntoView({ behavior: "smooth", block: "nearest" }); }

    function deleteRun(runId) {
      if (!confirm("Delete this run?")) return;
      fetch("/api/runs/" + runId, { method: "DELETE" })
        .then(function(r) {
          if (r.ok) {
            if (currentRunId === runId) {
              currentRunId = null;
              resetPanels();
            }
            updateHistory();
          }
        })
        .catch(function(err) {
          console.error("Delete failed:", err);
        });
    }

    function formatTime(ts) {
      var d = new Date(ts);
      var h = d.getHours(), m = d.getMinutes(), ampm = h >= 12 ? "pm" : "am";
      h = h % 12; if (h === 0) h = 12;
      return h + ":" + (m < 10 ? "0" : "") + m + ampm;
    }

    connectSSE();
    updateHistory();
  })();
  </script>
</body>
</html>

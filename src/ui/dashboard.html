<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Orchestrator â€” Mindra</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #09090b;
      --surface: #111114;
      --surface2: #18181b;
      --surface3: #1f1f23;
      --border: #27272a;
      --border-hover: #3f3f46;
      --text: #fafafa;
      --text-secondary: #a1a1aa;
      --text-dim: #71717a;

      --purple: #8B5CF6;
      --purple-light: #a78bfa;
      --purple-dark: #7c3aed;
      --purple-glow: rgba(139, 92, 246, 0.15);
      --purple-glow-strong: rgba(139, 92, 246, 0.3);

      --running: #8B5CF6;
      --pending: #3f3f46;
      --done: #22c55e;
      --done-dim: #166534;
      --failed: #ef4444;
      --failed-dim: #7f1d1d;

      --radius: 10px;
      --radius-sm: 6px;
    }

    body {
      font-family: 'Outfit', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      height: 56px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      background: linear-gradient(135deg, var(--purple), var(--purple-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
      box-shadow: 0 0 12px var(--purple-glow-strong);
    }

    .logo-text {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .logo-text span {
      color: var(--text-dim);
      font-weight: 400;
    }

    #connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-dim);
      font-weight: 400;
    }

    #connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--pending);
      transition: background 0.3s;
    }

    #connection-dot.connected { background: var(--done); box-shadow: 0 0 6px rgba(34, 197, 94, 0.4); }
    #connection-dot.disconnected { background: var(--failed); }

    /* ---- Main layout ---- */
    main {
      max-width: 880px;
      margin: 0 auto;
      padding: 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: border-color 0.2s;
    }

    section h2 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-dim);
      margin-bottom: 14px;
    }

    .hidden { display: none !important; }

    /* ---- Goal form ---- */
    #goal-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      font-weight: 400;
      padding: 12px 14px;
      resize: vertical;
      min-height: 64px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #goal-input::placeholder { color: var(--text-dim); }

    #goal-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 3px var(--purple-glow);
    }

    .form-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .form-row label {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 400;
    }

    .form-row input[type="number"] {
      width: 56px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 5px 8px;
      transition: border-color 0.2s;
    }

    .form-row input[type="number"]:focus {
      outline: none;
      border-color: var(--purple);
    }

    #submit-btn {
      margin-left: auto;
      background: linear-gradient(135deg, var(--purple), var(--purple-dark));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 8px 28px;
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 2px 8px var(--purple-glow);
    }

    #submit-btn:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 4px 14px var(--purple-glow-strong); }
    #submit-btn:active { transform: translateY(0); }
    #submit-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

    /* ---- State banner ---- */
    #state-banner {
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: var(--radius);
    }

    #state-banner.thinking {
      background: var(--purple-glow);
      border: 1px solid rgba(139, 92, 246, 0.25);
      color: var(--purple-light);
    }
    #state-banner.executing {
      background: var(--purple-glow);
      border: 1px solid rgba(139, 92, 246, 0.25);
      color: var(--purple-light);
    }
    #state-banner.done {
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #86efac;
    }
    #state-banner.error {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    /* ---- Step timeline ---- */
    #steps-container {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      color: var(--purple-light);
      font-size: 13px;
      font-weight: 500;
      background: var(--surface2);
      border: 1px dashed rgba(139, 92, 246, 0.25);
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--purple-light);
      animation: thinking-bounce 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinking-bounce {
      0%, 80%, 100% { opacity: 0.25; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1.1); }
    }

    .step-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 10px;
      overflow: hidden;
      transition: border-color 0.3s;
    }

    .step-card.step-complete {
      border-color: rgba(34, 197, 94, 0.2);
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface3);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 500;
    }

    .step-number {
      color: var(--purple-light);
      font-weight: 600;
    }

    .step-task-count {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-dim);
      margin-left: 6px;
    }

    .step-status-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 10px;
      border-radius: 100px;
    }

    .step-status-badge.running {
      background: var(--purple-glow);
      color: var(--purple-light);
    }
    .step-status-badge.complete {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
    }

    .step-tasks {
      padding: 6px 0;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 16px;
      font-size: 12px;
      transition: background 0.15s;
    }

    .task-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .task-status-dot {
      width: 9px;
      height: 9px;
      min-width: 9px;
      border-radius: 50%;
      margin-top: 4px;
      transition: background 0.3s, box-shadow 0.3s;
    }

    .task-status-dot.pending { background: var(--pending); }
    .task-status-dot.running {
      background: var(--purple);
      box-shadow: 0 0 6px var(--purple-glow-strong);
      animation: pulse-purple 2s ease-in-out infinite;
    }
    .task-status-dot.done { background: var(--done); }
    .task-status-dot.failed { background: var(--failed); }

    @keyframes pulse-purple {
      0%, 100% { box-shadow: 0 0 0 0 var(--purple-glow-strong); }
      50% { box-shadow: 0 0 0 5px rgba(139, 92, 246, 0); }
    }

    .task-info {
      flex: 1;
      min-width: 0;
    }

    .task-id {
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11.5px;
      color: var(--text);
      margin-right: 6px;
    }

    .task-agent-badge {
      display: inline-block;
      font-size: 9.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 1px 7px;
      border-radius: 100px;
      background: var(--purple-glow);
      color: var(--purple-light);
      margin-left: 4px;
      vertical-align: middle;
    }

    .task-desc {
      display: block;
      color: var(--text-secondary);
      margin-top: 2px;
      line-height: 1.4;
    }

    .task-output-toggle {
      display: inline-block;
      margin-top: 6px;
      font-size: 11px;
      color: var(--purple-light);
      cursor: pointer;
      user-select: none;
      border: none;
      background: none;
      font-family: 'Outfit', sans-serif;
      padding: 0;
      font-weight: 500;
      transition: color 0.15s;
    }

    .task-output-toggle:hover {
      color: var(--purple);
      text-decoration: underline;
    }

    .task-output {
      margin-top: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .task-result-badge {
      font-size: 9.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      border-radius: 100px;
      margin-top: 4px;
      display: inline-block;
    }

    .task-result-badge.ok { background: rgba(34, 197, 94, 0.1); color: #86efac; }
    .task-result-badge.error { background: rgba(239, 68, 68, 0.1); color: #fca5a5; }
    .task-result-badge.timeout { background: rgba(234, 179, 8, 0.1); color: #fde68a; }

    /* ---- Legend ---- */
    .legend {
      display: flex;
      gap: 18px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 400;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ---- Final answer ---- */
    #final-answer-panel { border-color: rgba(34, 197, 94, 0.15); }

    #final-answer-output {
      font-size: 13.5px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 18px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.7;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    /* ---- Run history ---- */
    #history-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      padding: 8px 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      border: 1px solid transparent;
    }

    .history-item:hover { background: var(--surface3); border-color: var(--border); }
    .history-item.active { border-color: var(--purple); background: var(--purple-glow); }

    .history-goal {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 400;
    }

    .history-time {
      font-size: 10px;
      color: var(--text-dim);
      white-space: nowrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .history-state {
      font-size: 9.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      border-radius: 100px;
      min-width: 60px;
      text-align: center;
    }

    .history-state.done { background: rgba(34, 197, 94, 0.1); color: #86efac; }
    .history-state.error { background: rgba(239, 68, 68, 0.1); color: #fca5a5; }
    .history-state.executing,
    .history-state.thinking { background: var(--purple-glow); color: var(--purple-light); }

    /* ---- Scrollbar ---- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">M</div>
      <div class="logo-text">OpenClaw <span>Orchestrator</span></div>
    </div>
    <div id="connection-status">
      <div id="connection-dot"></div>
      <span id="connection-label">connecting...</span>
    </div>
  </header>

  <main>
    <section id="goal-panel">
      <h2>Goal</h2>
      <form id="goal-form">
        <textarea id="goal-input" placeholder="Describe what you want to accomplish..." rows="3"></textarea>
        <div class="form-row">
          <label>Concurrency: <input type="number" id="concurrency" value="8" min="1" max="32"></label>
          <button type="submit" id="submit-btn">Run</button>
        </div>
      </form>
    </section>

    <section id="state-banner" class="hidden"></section>

    <section id="steps-panel" class="hidden">
      <h2>Step Timeline</h2>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--pending)"></div>Pending</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--running)"></div>Running</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--done)"></div>Done</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--failed)"></div>Failed</div>
      </div>
      <div id="steps-container"></div>
    </section>

    <section id="final-answer-panel" class="hidden">
      <h2>Final Answer</h2>
      <div id="final-answer-output"></div>
    </section>

    <section id="history-panel" class="hidden">
      <h2>Run History</h2>
      <div id="history-list"></div>
    </section>
  </main>

  <script>
  (function() {
    "use strict";

    var currentRunId = null;
    var eventSource = null;
    var stepsData = {};

    function connectSSE() {
      eventSource = new EventSource("/api/events");
      eventSource.onmessage = function(e) {
        try { handleEvent(JSON.parse(e.data)); } catch (err) { console.error("SSE parse error:", err); }
      };
      eventSource.onopen = function() { updateConnection(true); };
      eventSource.onerror = function() { updateConnection(false); };
    }

    function updateConnection(connected) {
      var dot = document.getElementById("connection-dot");
      var label = document.getElementById("connection-label");
      dot.className = connected ? "connected" : "disconnected";
      label.textContent = connected ? "connected" : "reconnecting...";
    }

    function handleEvent(event) {
      if (event.runId !== currentRunId) return;
      switch (event.type) {
        case "run:started":
          showBanner("thinking", "Thinking...");
          showThinkingIndicator();
          show("steps-panel");
          break;
        case "step:thinking":
          showBanner("thinking", "Thinking \u2014 deciding step " + event.stepNumber);
          showThinkingIndicator();
          break;
        case "step:started":
          removeThinkingIndicator();
          showBanner("executing", "Executing step " + event.stepNumber);
          addStepCard(event.stepNumber, event.taskIds, event.tasks);
          show("steps-panel");
          break;
        case "task:started":
          updateTaskStatus(event.stepNumber, event.taskId, "running");
          break;
        case "task:ended":
          updateTaskStatus(event.stepNumber, event.taskId, event.status, event.result);
          break;
        case "step:ended":
          markStepComplete(event.stepNumber);
          break;
        case "run:complete":
          removeThinkingIndicator();
          var durSec = (event.durationMs / 1000).toFixed(1);
          showBanner("done", "Completed in " + durSec + "s");
          if (event.answer) showFinalAnswer(event.answer);
          document.getElementById("submit-btn").disabled = false;
          updateHistory();
          break;
        case "run:error":
          removeThinkingIndicator();
          showBanner("error", "Error: " + event.error);
          document.getElementById("submit-btn").disabled = false;
          updateHistory();
          break;
      }
    }

    function showThinkingIndicator() {
      removeThinkingIndicator();
      var container = document.getElementById("steps-container");
      var indicator = document.createElement("div");
      indicator.id = "thinking-indicator";
      indicator.className = "thinking-indicator";
      indicator.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div><span>Thinking...</span>';
      container.appendChild(indicator);
      scrollIntoViewIfNeeded(indicator);
    }

    function removeThinkingIndicator() {
      var el = document.getElementById("thinking-indicator");
      if (el) el.remove();
    }

    function addStepCard(stepNumber, taskIds, taskDetails) {
      var tasks = {};
      for (var i = 0; i < taskIds.length; i++) {
        var detail = taskDetails && taskDetails[i];
        tasks[taskIds[i]] = { id: taskIds[i], task: detail ? detail.task : "", agent: detail ? detail.agent : undefined, status: "pending", result: null };
      }
      stepsData[stepNumber] = { tasks: tasks };

      var container = document.getElementById("steps-container");
      var card = document.createElement("div");
      card.className = "step-card";
      card.id = "step-card-" + stepNumber;

      var header = document.createElement("div");
      header.className = "step-header";
      header.innerHTML = '<span><span class="step-number">Step ' + stepNumber + '</span><span class="step-task-count">' + taskIds.length + ' task' + (taskIds.length !== 1 ? 's' : '') + '</span></span><span class="step-status-badge running">running</span>';

      var tasksList = document.createElement("div");
      tasksList.className = "step-tasks";
      tasksList.id = "step-tasks-" + stepNumber;

      for (var i = 0; i < taskIds.length; i++) {
        var detail = taskDetails && taskDetails[i];
        tasksList.appendChild(createTaskItem(taskIds[i], detail ? detail.task : "", "pending", detail ? detail.agent : undefined));
      }

      card.appendChild(header);
      card.appendChild(tasksList);
      container.appendChild(card);
      scrollIntoViewIfNeeded(card);
    }

    function createTaskItem(taskId, taskDesc, status, agentName) {
      var item = document.createElement("div");
      item.className = "task-item";
      item.id = "task-item-" + sanitizeId(taskId);

      var dot = document.createElement("div");
      dot.className = "task-status-dot " + status;
      dot.id = "task-dot-" + sanitizeId(taskId);

      var info = document.createElement("div");
      info.className = "task-info";

      var line = document.createElement("div");
      var idSpan = document.createElement("span");
      idSpan.className = "task-id";
      idSpan.textContent = taskId;
      line.appendChild(idSpan);

      if (agentName) {
        var agentSpan = document.createElement("span");
        agentSpan.className = "task-agent-badge";
        agentSpan.textContent = agentName;
        line.appendChild(agentSpan);
      }

      info.appendChild(line);

      if (taskDesc) {
        var descSpan = document.createElement("span");
        descSpan.className = "task-desc";
        descSpan.textContent = taskDesc;
        info.appendChild(descSpan);
      }

      var outputContainer = document.createElement("div");
      outputContainer.id = "task-output-container-" + sanitizeId(taskId);
      info.appendChild(outputContainer);

      item.appendChild(dot);
      item.appendChild(info);
      return item;
    }

    function updateTaskStatus(stepNumber, taskId, status, result) {
      if (stepsData[stepNumber] && stepsData[stepNumber].tasks[taskId]) {
        stepsData[stepNumber].tasks[taskId].status = status;
        if (result) stepsData[stepNumber].tasks[taskId].result = result;
      }
      var dot = document.getElementById("task-dot-" + sanitizeId(taskId));
      if (dot) dot.className = "task-status-dot " + status;

      if (result && (status === "done" || status === "failed")) {
        var outputContainer = document.getElementById("task-output-container-" + sanitizeId(taskId));
        if (outputContainer && !outputContainer.hasChildNodes()) renderTaskResult(outputContainer, taskId, result);
      }
    }

    function renderTaskResult(container, taskId, result) {
      var badge = document.createElement("span");
      badge.className = "task-result-badge " + result.status;
      badge.textContent = result.status;
      container.appendChild(badge);

      if (result.output) {
        var toggleId = "toggle-" + sanitizeId(taskId);
        var outputId = "output-" + sanitizeId(taskId);

        var toggle = document.createElement("button");
        toggle.className = "task-output-toggle";
        toggle.id = toggleId;
        toggle.textContent = "\u25B6 Show output";
        toggle.addEventListener("click", function() {
          var outputEl = document.getElementById(outputId);
          if (!outputEl) return;
          var visible = outputEl.style.display !== "none";
          outputEl.style.display = visible ? "none" : "block";
          toggle.textContent = visible ? "\u25B6 Show output" : "\u25BC Hide output";
        });

        var outputPre = document.createElement("pre");
        outputPre.className = "task-output";
        outputPre.id = outputId;
        outputPre.style.display = "none";
        outputPre.textContent = result.output;

        container.appendChild(document.createElement("br"));
        container.appendChild(toggle);
        container.appendChild(outputPre);
      }
    }

    function markStepComplete(stepNumber) {
      var card = document.getElementById("step-card-" + stepNumber);
      if (!card) return;
      card.classList.add("step-complete");
      var badge = card.querySelector(".step-status-badge");
      if (badge) { badge.className = "step-status-badge complete"; badge.textContent = "complete"; }
    }

    function showFinalAnswer(text) {
      document.getElementById("final-answer-output").textContent = text;
      show("final-answer-panel");
      scrollIntoViewIfNeeded(document.getElementById("final-answer-panel"));
    }

    document.getElementById("goal-form").addEventListener("submit", function(e) {
      e.preventDefault();
      var goal = document.getElementById("goal-input").value.trim();
      if (!goal) return;
      resetPanels();
      var body = { goal: goal, maxConcurrency: parseInt(document.getElementById("concurrency").value, 10) || 8 };
      document.getElementById("submit-btn").disabled = true;

      fetch("/api/runs", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
        .then(function(r) { return r.json(); })
        .then(function(data) { currentRunId = data.runId; })
        .catch(function(err) { showBanner("error", "Failed to submit: " + err.message); document.getElementById("submit-btn").disabled = false; });
    });

    function updateHistory() {
      fetch("/api/runs").then(function(r) { return r.json(); }).then(function(runs) {
        if (!runs.length) return;
        show("history-panel");
        var list = document.getElementById("history-list");
        list.innerHTML = "";
        for (var i = 0; i < runs.length; i++) {
          var run = runs[i];
          var item = document.createElement("div");
          item.className = "history-item" + (run.runId === currentRunId ? " active" : "");

          var stateSpan = document.createElement("span");
          stateSpan.className = "history-state " + esc(run.state);
          stateSpan.textContent = run.state;

          var goalSpan = document.createElement("span");
          goalSpan.className = "history-goal";
          goalSpan.textContent = run.goal;

          var timeSpan = document.createElement("span");
          timeSpan.className = "history-time";
          if (run.startedAt) timeSpan.textContent = formatTime(run.startedAt);

          item.appendChild(stateSpan);
          item.appendChild(goalSpan);
          item.appendChild(timeSpan);
          item.addEventListener("click", (function(rid) { return function() { loadRun(rid); }; })(run.runId));
          list.appendChild(item);
        }
      }).catch(function() {});
    }

    function loadRun(runId) {
      fetch("/api/runs/" + runId).then(function(r) { return r.json(); }).then(function(run) {
        resetPanels();
        currentRunId = run.runId;

        if (run.steps && run.steps.length) {
          show("steps-panel");
          for (var s = 0; s < run.steps.length; s++) {
            var step = run.steps[s];
            var tasksMap = {};
            for (var t = 0; t < step.tasks.length; t++) {
              var task = step.tasks[t];
              tasksMap[task.id] = { id: task.id, task: task.task, status: task.status, result: task.result || null };
            }
            stepsData[step.stepNumber] = { tasks: tasksMap };
            buildStepCardFromData(step);
          }
        }

        if (run.state === "thinking") { showThinkingIndicator(); show("steps-panel"); }
        if (run.finalAnswer) showFinalAnswer(run.finalAnswer);

        var bannerMsg = run.state;
        if (run.state === "done") {
          bannerMsg = (run.finishedAt && run.startedAt) ? "Completed in " + ((run.finishedAt - run.startedAt) / 1000).toFixed(1) + "s" : "Completed";
        } else if (run.state === "error") {
          bannerMsg = "Error: " + (run.error || "unknown");
        } else if (run.state === "thinking") {
          bannerMsg = "Thinking...";
        } else if (run.state === "executing") {
          bannerMsg = "Executing...";
        }
        showBanner(run.state, bannerMsg);
        document.getElementById("submit-btn").disabled = (run.state === "thinking" || run.state === "executing");
        updateHistory();
      }).catch(function() {});
    }

    function buildStepCardFromData(step) {
      var container = document.getElementById("steps-container");
      var card = document.createElement("div");
      card.className = "step-card";
      card.id = "step-card-" + step.stepNumber;

      var allDone = true;
      for (var i = 0; i < step.tasks.length; i++) {
        if (step.tasks[i].status !== "done" && step.tasks[i].status !== "failed") { allDone = false; break; }
      }
      if (allDone) card.classList.add("step-complete");

      var header = document.createElement("div");
      header.className = "step-header";
      header.innerHTML = '<span><span class="step-number">Step ' + step.stepNumber + '</span><span class="step-task-count">' + step.tasks.length + ' task' + (step.tasks.length !== 1 ? 's' : '') + '</span></span><span class="step-status-badge ' + (allDone ? 'complete' : 'running') + '">' + (allDone ? 'complete' : 'running') + '</span>';

      var tasksList = document.createElement("div");
      tasksList.className = "step-tasks";
      tasksList.id = "step-tasks-" + step.stepNumber;

      for (var i = 0; i < step.tasks.length; i++) {
        var task = step.tasks[i];
        var taskItem = createTaskItem(task.id, task.task, task.status, task.agent);
        tasksList.appendChild(taskItem);
        if (task.result) {
          var outputContainer = document.getElementById("task-output-container-" + sanitizeId(task.id));
          if (outputContainer) renderTaskResult(outputContainer, task.id, task.result);
        }
      }

      card.appendChild(header);
      card.appendChild(tasksList);
      container.appendChild(card);
    }

    function show(id) { document.getElementById(id).classList.remove("hidden"); }
    function hide(id) { document.getElementById(id).classList.add("hidden"); }

    function showBanner(state, msg) {
      var banner = document.getElementById("state-banner");
      banner.className = state;
      banner.textContent = msg;
      show("state-banner");
    }

    function resetPanels() {
      stepsData = {};
      document.getElementById("steps-container").innerHTML = "";
      document.getElementById("final-answer-output").textContent = "";
      hide("state-banner");
      hide("steps-panel");
      hide("final-answer-panel");
    }

    function esc(str) { var div = document.createElement("div"); div.textContent = str || ""; return div.innerHTML; }
    function sanitizeId(id) { return id.replace(/[^a-zA-Z0-9_-]/g, "_"); }
    function scrollIntoViewIfNeeded(el) { if (el) el.scrollIntoView({ behavior: "smooth", block: "nearest" }); }

    function formatTime(ts) {
      var d = new Date(ts);
      var h = d.getHours(), m = d.getMinutes(), ampm = h >= 12 ? "pm" : "am";
      h = h % 12; if (h === 0) h = 12;
      return h + ":" + (m < 10 ? "0" : "") + m + ampm;
    }

    connectSSE();
    updateHistory();
  })();
  </script>
</body>
</html>
